<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Base Advisor AI ‚Äî Dashboard</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#0f1733;
      --muted:#9aa7c7;
      --text:#e7ecff;
      --line:#22305a;
      --ok:#2be4a7;
      --warn:#ffcc66;
      --crit:#ff5c7a;
      --info:#6aa8ff;
      --chip:#131d3f;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background: radial-gradient(1200px 700px at 20% -10%, #1a2a6a22, transparent 60%),
                  radial-gradient(900px 600px at 80% 10%, #2b7cff22, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 60px}
    .top{
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;flex-wrap:wrap;
      margin-bottom:18px;
    }
    .title{display:flex;flex-direction:column;gap:6px;}
    .title h1{margin:0;font-size:22px;letter-spacing:0.2px;}
    .subtitle{color:var(--muted);font-size:13px;line-height:1.35;max-width:720px;}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background: #0c1430;
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      font-weight:600;font-size:13px;
      text-decoration:none;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{border-color:#3653a9}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;}
    .card{
      background: linear-gradient(180deg, #111a3a, #0e1632);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .kpi{grid-column:span 3}
    .kpi .label{color:var(--muted);font-size:12px;margin-bottom:6px}
    .kpi .value{font-size:16px;font-weight:800;letter-spacing:0.2px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .big{grid-column:span 6}
    .full{grid-column:span 12}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--muted);font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.crit{background:var(--crit)}
    .dot.info{background:var(--info)}

    .section-title{
      margin:6px 0 10px;
      font-size:14px;font-weight:900;letter-spacing:0.3px;
    }
    .muted{color:var(--muted)}
    .pre{
      white-space:pre-wrap;
      line-height:1.45;
      background:#0b1330;
      border:1px solid var(--line);
      padding:12px;border-radius:14px;
      font-size:13px;
    }

    /* CARDS DE A√á√ÉO */
    .cards{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;}
    .action-card{grid-column:span 6}
    .ac-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .badge{
      padding:6px 10px;border-radius:999px;
      font-weight:900;font-size:11px;letter-spacing:0.2px;
      background:var(--chip);border:1px solid var(--line);color:var(--muted);
      white-space:nowrap;
    }
    .badge.critical{color:#ffd3da;border-color:#ff5c7a55;background:#2a1020}
    .badge.warning{color:#ffe6b8;border-color:#ffcc6655;background:#2a220f}
    .badge.info{color:#cfe4ff;border-color:#6aa8ff55;background:#0f1f34}
    .badge.success{color:#bff8e6;border-color:#2be4a755;background:#0f2a22}
    .ac-title{font-size:14px;font-weight:900;margin:0 0 6px}
    .ac-text{font-size:13px;color:var(--muted);margin:0 0 8px;line-height:1.35}
    .ac-cta{
      margin-top:10px;
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .cta-box{
      flex:1 1 260px;
      background:#0b1330;border:1px dashed #2c3b6a;
      padding:10px;border-radius:12px;
      font-size:12px;color:var(--text);
    }
    .mini-btn{
      border:1px solid var(--line);
      background:#0c1430;
      color:var(--text);
      padding:9px 10px;border-radius:12px;
      cursor:pointer;font-weight:800;font-size:12px;
    }
    .mini-btn:hover{border-color:#3653a9}

    /* TIMELINE */
    #timeline {scroll-margin-top: 20px;}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:12.5px}
    th{color:var(--muted);text-align:left;font-weight:800}
    td{color:var(--text)}
    .score{display:inline-flex;align-items:center;gap:8px;}
    .bar{
      width:90px;height:9px;border-radius:999px;background:#09102a;border:1px solid var(--line);overflow:hidden;
    }
    .bar > span{display:block;height:100%}
    .chip{
      padding:6px 10px;border-radius:999px;background:var(--chip);
      border:1px solid var(--line);color:var(--muted);font-size:12px;
      white-space:nowrap;
    }

    .err{
      border-color:#ff5c7a55;
      background: linear-gradient(180deg, #2a0f20, #120a18);
      color:#ffd3da;
    }

    @media (max-width: 980px){
      .kpi{grid-column:span 6}
      .big{grid-column:span 12}
      .action-card{grid-column:span 12}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>Base Advisor AI ‚Äî Dashboard</h1>
        <div class="subtitle">
          Identidade onchain, leitura de saldo na Base, timeline (SQLite), score de risco/tend√™ncia e
          <b>Camada de Resolu√ß√£o</b> com Cards de A√ß√£o.
        </div>
        <div class="pill" style="margin-top:8px;">
          {% if ok %}
            <span class="dot ok"></span><span>Opera√ß√£o Plena</span>
          {% else %}
            <span class="dot crit"></span><span>Erro na execu√ß√£o</span>
          {% endif %}
          <span>‚Ä¢</span>
          <span class="muted">Atualizado:</span>
          <span class="mono nowrap">{{ payload.created_at }}</span>
        </div>
      </div>

      <div class="btns">
        <a class="btn" href="/api/force" target="_blank">‚ö° For√ßar novo relat√≥rio</a>
        <a class="btn" href="/api/status" target="_blank">üßæ Ver JSON /api/status</a>
        <a class="btn" href="#timeline">üïí Ir para Timeline</a>
      </div>
    </div>

    {% if error_msg %}
      <div class="card err full" style="margin-bottom:12px;">
        <div class="section-title">Erro</div>
        <div class="pre">{{ error_msg }}</div>
      </div>
    {% endif %}

    <div class="grid">
      <div class="card kpi">
        <div class="label">Endere√ßo</div>
        <div class="value mono nowrap" title="{{ payload.address }}">{{ payload.address }}</div>
      </div>

      <div class="card kpi">
        <div class="label">Saldo (ETH)</div>
        <div class="value">{{ "%.8f"|format(payload.balance_eth) }}</div>
        <div class="muted" style="margin-top:6px;font-size:12px;">
          Low: {{ low_gas }} ‚Ä¢ Crit: {{ critical_gas }}
        </div>
      </div>

      <div class="card kpi">
        <div class="label">Pre√ßo ETH (USD)</div>
        <div class="value">
          {% if payload.eth_price_usd %}
            {{ "%.2f"|format(payload.eth_price_usd) }}
          {% else %}
            N/A
          {% endif %}
        </div>
        <div class="muted" style="margin-top:6px;font-size:12px;">
          Cache: {{ payload.cache.price_cache_ttl }}s
        </div>
      </div>

      <div class="card kpi">
        <div class="label">Score Operacional</div>
        <div class="value">{{ payload.score }}/100</div>
        <div class="muted" style="margin-top:6px;font-size:12px;">
          Alerta ‚â• {{ alert_threshold }}
        </div>
      </div>

      <div class="card big">
        <div class="section-title">Estado</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <span class="chip">Rede: {{ payload.network }}</span>
          <span class="chip">RPC usado: {{ payload.rpc_used }}</span>
          <span class="chip">Bloco: {{ payload.block_number if payload.block_number else "N/A" }}</span>
          <span class="chip">Tend√™ncia: {{ payload.trend }} ({{ "%.2f"|format(payload.trend_pct) }}%)</span>
        </div>

        <div style="margin-top:12px;">
          <div class="section-title">Alertas</div>
          {% if payload.alerts and payload.alerts|length > 0 %}
            <ul style="margin:0;padding-left:18px;color:var(--muted);line-height:1.45;">
              {% for a in payload.alerts %}
                <li>{{ a }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="muted">Nenhum alerta no momento.</div>
          {% endif %}
        </div>

        <div style="margin-top:12px;">
          <div class="section-title">Recomenda√ß√µes T√©cnicas</div>
          {% if payload.recommendations and payload.recommendations|length > 0 %}
            <ul style="margin:0;padding-left:18px;color:var(--muted);line-height:1.45;">
              {% for r in payload.recommendations %}
                <li>{{ r }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="muted">Sem recomenda√ß√µes adicionais.</div>
          {% endif %}
        </div>
      </div>

      <div class="card big">
        <div class="section-title">IA (Gemini)</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
          <span class="chip">Status: {{ payload.ai_status }}</span>
          <span class="chip nowrap" title="{{ payload.model_id }}">Modelo: <span class="mono nowrap">{{ payload.model_id }}</span></span>
          <span class="chip">Cache relat√≥rio: {{ payload.cache.report_ttl }}s</span>
        </div>

        {% if payload.report_text %}
          <div class="pre">{{ payload.report_text }}</div>
        {% else %}
          <div class="muted">Relat√≥rio de IA indispon√≠vel (ou API_KEY n√£o configurada).</div>
        {% endif %}

        <div class="muted" style="margin-top:10px;font-size:12px;line-height:1.35;">
          Nota: este app fornece an√°lise t√©cnica/operacional e n√£o constitui recomenda√ß√£o de investimento.
        </div>
      </div>

      <div class="card full">
        <div class="section-title">Fase 6 ‚Äî Cards de A√ß√£o (Camada de Resolu√ß√£o)</div>
        <div class="muted" style="margin-bottom:12px;">
          Esses cards aparecem automaticamente quando o agente detecta um cen√°rio (GAS baixo, falta de RPC 2, pre√ßo indispon√≠vel, score cr√≠tico, etc.).
        </div>

        <div class="cards">
          {% for c in payload.cards %}
            <div class="card action-card">
              <div class="ac-head">
                <div>
                  <div class="ac-title">{{ c.title }}</div>
                  <p class="ac-text"><b>Por qu√™:</b> {{ c.why }}</p>
                  <p class="ac-text"><b>A√ß√£o:</b> {{ c.action }}</p>
                  {% if c.hint %}
                    <p class="ac-text"><b>Dica:</b> {{ c.hint }}</p>
                  {% endif %}
                </div>
                <span class="badge {{ c.level }}">{{ c.level|upper }}</span>
              </div>

              <div class="ac-cta">
                <div class="cta-box mono" id="val-{{ loop.index }}">{{ c.cta_value }}</div>
                <button class="mini-btn" onclick="copyText('val-{{ loop.index }}')">{{ c.cta_label }}</button>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="card full" id="timeline">
        <div class="section-title">Timeline (SQLite) ‚Äî √∫ltimos relat√≥rios</div>
        <div class="muted" style="margin-bottom:10px;">
          Hist√≥rico persistente para provar ‚Äúmem√≥ria‚Äù do agente e varia√ß√£o ao longo do tempo.
        </div>

        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Data</th>
              <th>Saldo (ETH)</th>
              <th>Pre√ßo (USD)</th>
              <th>Trend</th>
              <th>Score</th>
              <th>Modelo</th>
            </tr>
          </thead>
          <tbody>
            {% for h in history %}
              <tr>
                <td>{{ h.id }}</td>
                <td class="mono">{{ h.created_at }}</td>
                <td>{{ "%.8f"|format(h.balance_eth) }}</td>
                <td>
                  {% if h.eth_price_usd %}
                    {{ "%.2f"|format(h.eth_price_usd) }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>{{ h.trend if h.trend else "‚Äî" }}</td>
                <td>
                  <span class="score">
                    <span>{{ h.score if h.score is not none else "‚Äî" }}</span>
                    {% if h.score is not none %}
                      <span class="bar">
                        <span style="width:{{ h.score }}%; background:
                          {% if h.score >= alert_threshold %} var(--crit)
                          {% elif h.score >= 40 %} var(--warn)
                          {% else %} var(--ok)
                          {% endif %};
                        "></span>
                      </span>
                    {% endif %}
                  </span>
                </td>
                <td class="mono nowrap" title="{{ h.model_id }}">{{ h.model_id if h.model_id else "‚Äî" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="muted" style="margin-top:10px;font-size:12px;">
          Dica: se voc√™ quiser ‚Äúmais mem√≥ria‚Äù, aumente o limit em <span class="mono">/api/history?limit=50</span>.
        </div>
      </div>

    </div>
  </div>

  <script>
    function copyText(id){
      const el = document.getElementById(id);
      const text = el.innerText || el.textContent;
      navigator.clipboard.writeText(text);
    }
  </script>
</body>
</html>
